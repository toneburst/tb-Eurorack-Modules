function TBMWMIDIOut(b,a){this.instanceid="0";if(b){this.instanceid=b}else{console.log("WARNING: You should specify a unique instance ID when instantiating the TBWMMIDIOut object.")}this.savesettingslocal=false;if(a!==undefined&&a.savesettings===true){this.savesettingslocal=true}this.idprefix="tbwm-ui-midiout";this.outputselectid=this.idprefix+"-device";if(this.instanceid){this.outputselectid+="-"+this.instanceid}this.channelselectid=this.idprefix+"-channel";if(this.instanceid){this.channelselectid+="-"+this.instanceid}this.testoutputbuttonid=this.idprefix+"-testoutput";if(this.instanceid){this.testoutputbuttonid+="-"+this.instanceid}this.containerclass="tbwm-ui";this.havemidi=false;this.havemidiout=false;this.midiaccess={};this.outputs={};this.testnotenum=64;this.outputsettings={device:null,channel:1};this.cookiename="tbwm-midioutputprefs";this.utils=null;try{if(typeof TBWMSharedfunctions()===undefined){throw"TBWMSharedfunctions() Object not available"}else{this.utils=new TBWMSharedfunctions()}}catch(c){this.errornoutils(c)}return this}MicroEvent.mixin(TBMWMIDIOut);TBMWMIDIOut.prototype.errornoutils=function(b){var a=(b)?" Error was: '"+b+"'.":"";console.log("Error: No utility function available, exiting."+a)};TBMWMIDIOut.prototype.savesettings=function(){if(this.savesettingslocal){this.utils.savesettings(this.cookiename,JSON.stringify(this.outputsettings),365)}};TBMWMIDIOut.prototype.recallsavedsettings=function(){if(this.savesettingslocal){var b=this.utils.getsettings(this.cookiename);if(b){var a=JSON.parse(b);if(a!==null){if(a.device){this.outputsettings.device=a.device}if(a.channel){this.outputsettings.channel=a.channel}}}}};TBMWMIDIOut.prototype.deletesavedsettings=function(){this.deletecookie(this.cookiename)};TBMWMIDIOut.prototype.errornomidi=function(a){this.havemidi=false;console.log(a)};TBMWMIDIOut.prototype.errornooutputdevice=function(){this.havemidiout=false;var a="Error: No MIDI output device is accessible.";console.log(a)};TBMWMIDIOut.prototype.channelmessage=function(c,a){var b={noteoff:8,noteon:9,controlchange:11,channelmode:11,programchange:12,channelaftertouch:13,pitchbend:14,allnotesoff:123};if(!b[c]){console.log("Error: MIDI Channel message not found")}else{return(b[c]<<4)+(a-1)}};TBMWMIDIOut.prototype.systemmessage=function(b){var a={sysex:240,timecode:241,songposition:242,songselect:243,tuningrequest:246,sysexend:247,clock:248,start:250,"continue":251,stop:252,activesensing:254,reset:255,};if(!a[b]){console.log("Error: MIDI System message not found")}else{return(a[b]<<4)+(ch-1)}};TBMWMIDIOut.prototype.time=function(b){var a=window.performance.now();if(b){return a+b}else{return a}};TBMWMIDIOut.prototype.init=function(){var b=this;navigator.requestMIDIAccess().then(c,a);function c(d){b.havemidi=true;b.midiaccess=d;b.outputs=b.midiaccess.outputs;if(b.outputs.size>0){b.midiout=b.outputs.values().next().value;b.outputsettings.device=b.midiout.name;b.midiout.open();b.havemidiout=true;b.recallsavedsettings();b.setoutputdevice(b.outputsettings.device);b.setoutmidichannel(b.outputsettings.channel)}else{b.errornooutputdevice();b.havemidiout=false;b.trigger("midistatus","fail");return this}console.log("MIDI system successfully initialised.");b.trigger("midistatus","success")}function a(d){b.havemidi=false;b.havemidiin=false;b.havemidiout=false;console.log("Uh-oh! Something went wrong! Error code: "+d.code);b.trigger("midistatus","fail")}return this};TBMWMIDIOut.prototype.setoutputdevice=function(a){if(this.havemidiout){var b=null;this.outputs.forEach(function(c){if(c.id===a||c.name===a){if(!b){b=c}}});if(b){this.midiout.close();this.midiout=b;this.midiout.open();this.outputsettings.device=b.name;this.savesettings()}else{console.log("Error: MIDI output port "+a+" not available.")}}else{return this}return this};TBMWMIDIOut.prototype.addoutputselect=function(d){if(this.havemidi&&this.havemidiout&&this.utils){var b=this;var a=this.utils.DOMcheckelement(d.domcontainer);if(!a){return this}if(d.addlabel===true){a.appendChild(this.utils.DOMcreatelabel({labelfor:this.outputselectid,labeltext:(d.labeltext!==undefined)?d.labeltext:"MIDI Output Device"}))}var e=document.createElement("select");e.setAttribute("id",this.outputselectid);e.setAttribute("class",this.containerclass);var c=[];this.outputs.forEach(function(f){c.push({text:f.name,value:f.name})});var e=this.utils.DOMaddselect({id:this.outputselectid,options:c,selected:b.outputsettings.device});a.appendChild(e);e.addEventListener("change",function(){var f=this.value;b.setoutputdevice(f)})}else{this.errornooutputdevice()}this.savesettings();return this};TBMWMIDIOut.prototype.setoutmidichannel=function(a){this.midichannel=parseInt(a);this.savesettings()};TBMWMIDIOut.prototype.addoutchannelselect=function(f){if(this.havemidi&&this.havemidiout&&this.utils){var b=this.utils.DOMcheckelement(f.domcontainer);if(!b){return this}if(f.addlabel===true){b.appendChild(this.utils.DOMcreatelabel({labelfor:this.channelselectid,labeltext:(f.labeltext!==undefined)?f.labeltext:"MIDI Output Channel"}))}var e=[];for(var d=1;d<17;d++){e.push({text:d,value:d})}var c=this.utils.DOMaddselect({id:this.channelselectid,options:e,selected:this.outputsettings.channel});b.appendChild(c);var a=this;c.addEventListener("change",function(){a.outputsettings.channel=parseInt(this.value);a.setoutmidichannel(a.outputsettings.channel)})}else{return this}return this};TBMWMIDIOut.prototype.addtestbutton=function(c){if(this.havemidi&&this.havemidiout&&this.utils){var b=this.utils.DOMcheckelement(c.domcontainer);if(!b){return this}var d=this.utils.DOMaddbutton({id:this.testoutputbuttonid,text:(c.buttontext!==undefined)?c.buttontext:"Test MIDI Out"});b.appendChild(d);var a=this;d.addEventListener("mousedown",function(){a.send_noteon(null,a.testnotenum,127,null)},false);d.addEventListener("mouseup",function(){a.send_noteoff(null,a.testnotenum,127,null)},false)}else{return this}return this};TBMWMIDIOut.prototype.send_noteon=function(e,c,d,a){if(this.havemidi&&this.havemidiout){var b=(e)?e:this.midichannel;var f=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("noteon",b),c,d],f)}else{return this}return this};TBMWMIDIOut.prototype.send_noteoff=function(e,c,d,a){if(this.havemidi&&this.havemidiout){var b=(e)?e:this.midichannel;var f=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("noteoff",b),c,d],f)}else{return this}return this};TBMWMIDIOut.prototype.send_allnotesoff=function(c,a){if(this.havemidi&&this.havemidiout){var b=(c)?c:this.midichannel;var d=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("allnotesoff",b),0,0],this.time())}else{return this}return this};TBMWMIDIOut.prototype.send_controller=function(c,f,d,a){if(this.havemidi&&this.havemidiout){var b=(c)?c:this.midichannel;var e=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("controller",b),f,d],e)}else{return this}return this};TBMWMIDIOut.prototype.send_clocktick=function(){if(this.havemidi&&this.havemidiout){this.midiout.send([this.systemmessage("clock")],this.time())}else{return this}return this};TBMWMIDIOut.prototype.send_clockstop=function(){if(this.havemidi&&this.havemidiout){this.midiout.send([this.systemmessage("stop")],this.time())}else{return this}return this};TBMWMIDIOut.prototype.send_clockcontinue=function(){if(this.havemidi&&this.havemidiout){this.midiout.send([this.systemmessage("continue")],this.time())}else{return this}return this};