function TBWMNotequantiser(b,a){this.instanceid="0";if(b){this.instanceid=b}else{console.log("WARNING: You should specify a unique instance ID when instantiating the TBWMMIDIOut object.")}this.savesettingslocal=false;if(a!==undefined&&a.savesettings===true){this.savesettingslocal=true}this.mpscales=Array();this.mpscales[0]={name:"Chromatic",notes:[0,1,2,3,4,5,6,7,8,9,10,11]};this.mpscales[1]={name:"Ionian",notes:[0,0,2,2,4,5,5,7,7,9,9,11]};this.mpscales[2]={name:"Dorian",notes:[0,0,2,3,3,5,5,7,7,10,10]};this.mpscales[3]={name:"Phrygian",notes:[0,1,1,3,3,5,5,7,8,8,10,10]};this.mpscales[4]={name:"Lydian",notes:[0,0,2,2,4,4,6,7,7,9,11]};this.mpscales[5]={name:"Mixolydian",notes:[0,0,2,2,4,5,5,7,7,9,10,10]};this.mpscales[6]={name:"Aeolian Minor",notes:[0,0,2,3,3,5,5,7,8,8,10,10]};this.mpscales[7]={name:"Locrian",notes:[0,1,1,3,3,5,6,6,8,8,10,10]};this.mpscales[8]={name:"Blues Major",notes:[0,0,3,3,4,4,7,7,7,9,10,10]};this.mpscales[9]={name:"Blues Minor",notes:[0,0,3,3,3,5,6,7,7,10,10,10]};this.mpscales[10]={name:"Pentatonic Major",notes:[0,0,2,2,4,4,7,7,7,9,9,9]};this.mpscales[11]={name:"Pentatonic Minor",notes:[0,0,3,3,3,5,5,7,7,10,10,10]};this.mpscales[12]={name:"Raga Bhiarav",notes:[0,1,1,4,4,5,5,7,8,8,11,11]};this.mpscales[13]={name:"Raga Shri",notes:[0,1,1,4,4,4,6,7,8,8,11,11]};this.mpscales[14]={name:"Raga Rupatavi",notes:[0,1,1,3,3,5,5,7,7,10,10,11]};this.mpscales[15]={name:"Raga Todi",notes:[0,1,1,3,3,6,6,7,8,8,11,11]};this.mpscales[16]={name:"Raga Kaafi",notes:[0,0,2,2,4,5,5,5,9,9,10,11]};this.mpscales[17]={name:"Raga Meg",notes:[0,0,2,2,5,5,5,7,7,9,9,9]};this.mpscales[18]={name:"Raga Malkauns",notes:[0,0,3,3,3,5,5,8,8,8,10,10]};this.mpscales[19]={name:"Raga Deepak",notes:[0,0,3,3,4,4,6,6,8,8,10,10]};this.mpscales[20]={name:"Folkish",notes:[0,1,1,3,4,5,5,7,8,8,10,10]};this.mpscales[21]={name:"Japanese",notes:[0,1,1,1,5,5,5,7,8,8,8,8]};this.mpscales[22]={name:"Gamelan",notes:[0,1,1,3,3,3,7,7,8,8,8,8]};this.mpscales[23]={name:"Whole Tones",notes:[0,0,2,2,4,4,6,6,8,8,10,10]};this.scalesettings={scaleindex:0,scaleshift:0,scalerandomise:0,scaleflatten:0,scaletranspose:0};this.scale=this.mpscales[this.scalesettings.scaleindex]["notes"];this.idprefix="tbwm-ui-notequantiser";this.scalesselectid=this.idprefix+"-scale";if(this.instanceid){this.scalesselectid+="-"+this.instanceid}this.randomiserangeid=this.idprefix+"-random";if(this.instanceid){this.randomiserangeid+="-"+this.instanceid}this.shiftrangeid=this.idprefix+"-shift";if(this.instanceid){this.shiftrangeid+="-"+this.instanceid}this.flattenrangeid=this.idprefix+"-flatten";if(this.instanceid){this.flattenrangeid+="-"+this.instanceid}this.transposerangeid=this.idprefix+"-transpose";if(this.instanceid){this.transposerangeid+="-"+this.instanceid}this.utils=null;try{if(typeof TBWMSharedfunctions()===undefined){throw"TBWMSharedfunctions() Object not available"}else{this.utils=new TBWMSharedfunctions()}}catch(c){this.errornoutils(c)}this.cookiename="tbwm-quantiserprefs";if(this.savesettingslocal){this.recallsavedsettings()}if(a){this.mergesettings(a)}return this}TBWMNotequantiser.prototype.errornoutils=function(b){var a=(b)?" Error was: '"+b+"'.":"";console.log("Error: No utility function available, exiting."+a)};TBWMNotequantiser.prototype.getsettings=function(){return this.scalesettings};TBWMNotequantiser.prototype.mergesettings=function(a){if(a){if(a.scaleindex){this.scalesettings.scaleindex=a.scaleindex;this.scale=this.mpscales[this.scalesettings.scaleindex]["notes"]}if(a.scaleshift){this.scalesettings.scaleshift=a.scaleshift}if(a.scalerandomise){this.scalesettings.scalerandomise=a.scalerandomise}if(a.scaleflatten){this.scalesettings.scaleflatten=a.scaleflatten}if(a.scaletranspose){this.scalesettings.scaletranspose=a.scaletranspose}}else{console.log("Error: You need to pass in a settings object containing some or all of the following options: {scaleindex:[val],scaleshift:[val],scalerandomise:[val],scaleflatten:[val]},scaletranspose:[val]")}return this};TBWMNotequantiser.prototype.pushsettings=function(a,b){this.mergesettings(a);if(b===true){this.savesettings()}this.updateui();return this};TBWMNotequantiser.prototype.savesettings=function(){if(this.savesettingslocal){this.utils.savesettings(this.cookiename,JSON.stringify(this.scalesettings),365)}};TBWMNotequantiser.prototype.recallsavedsettings=function(){if(this.savesettingslocal){var b=this.utils.getsettings(this.cookiename);if(b){var a=JSON.parse(b);if(a!==null){this.mergesettings(a)}}}};TBWMNotequantiser.prototype.updateui=function(){};TBWMNotequantiser.prototype.setscale=function(a){this.scalesettings.scaleindex=Math.min(this.mpscales.length-1,a);this.scale=this.mpscales[a]["notes"];this.savesettings()};TBWMNotequantiser.prototype.addscaleselect=function(e){if(!this.utils){return this}var c=this.utils.DOMcheckelement(e.domcontainer);if(!c){return this}if(e.addlabel===true){c.appendChild(this.utils.DOMcreatelabel({labelfor:this.scalesselectid,labeltext:(e.labeltext!==undefined)?e.labeltext:"Select Scale"}))}var f=[];for(var d=0;d<this.mpscales.length;d++){f.push({text:this.mpscales[d]["name"],value:d})}var a=this.utils.DOMaddselect({id:this.scalesselectid,options:f,selected:this.scalesettings.scaleindex});c.appendChild(a);var b=this;a.addEventListener("change",function(){b.setscale(parseInt(this.value))});return this};TBWMNotequantiser.prototype.setshift=function(a){this.scalesettings.scaleshift=Math.max(a,0)%11;this.savesettings();return this};TBWMNotequantiser.prototype.addshiftselect=function(d){if(!this.utils){return this}var c=this.utils.DOMcheckelement(d.domcontainer);if(!c){return this}if(d.addlabel===true){c.appendChild(this.utils.DOMcreatelabel({labelfor:this.shiftrangeid,labeltext:(d.labeltext!==undefined)?d.labeltext:"Scale Shift Amount"}))}var b=this.utils.DOMaddrange({id:this.shiftrangeid,min:0,max:11,step:1,value:this.scalesettings.scaleshift});c.appendChild(b);var a=this;b.addEventListener("change",function(){a.setshift(parseInt(this.value))});return this};TBWMNotequantiser.prototype.setrandomise=function(a){this.scalesettings.scalerandomise=a;this.savesettings();return this};TBWMNotequantiser.prototype.addrandomrange=function(d){if(!this.utils){return this}var c=this.utils.DOMcheckelement(d.domcontainer);if(!c){return this}if(d.addlabel===true){c.appendChild(this.utils.DOMcreatelabel({labelfor:this.randomiserangeid,labeltext:(d.labeltext!==undefined)?d.labeltext:"Scale Randomise Amount"}))}var b=this.utils.DOMaddrange({id:this.randomiserangeid,min:0,max:1,step:0.01,value:this.scalesettings.scalerandomise});c.appendChild(b);var a=this;b.addEventListener("change",function(){a.setrandomise(parseFloat(this.value))});return this};TBWMNotequantiser.prototype.setflatten=function(a){this.scalesettings.scaleflatten=a;this.savesettings();return this};TBWMNotequantiser.prototype.addflattenrange=function(d){if(!this.utils){return this}var c=this.utils.DOMcheckelement(d.domcontainer);if(!c){return this}if(d.addlabel===true){c.appendChild(this.utils.DOMcreatelabel({labelfor:this.flattenrangeid,labeltext:(d.labeltext!==undefined)?d.labeltext:"Scale Flatten Amount"}))}var b=this.utils.DOMaddrange({id:this.flattenrangeid,min:0,max:1,step:0.01,value:this.scalesettings.scaleflatten});c.appendChild(b);var a=this;b.addEventListener("change",function(){a.setflatten(parseFloat(this.value))});return this};TBWMNotequantiser.prototype.settranspose=function(a){this.scalesettings.scaletranspose=parseInt(a);this.savesettings();return this};TBWMNotequantiser.prototype.addtransposeselect=function(d){if(!this.utils){return this}var c=this.utils.DOMcheckelement(d.domcontainer);if(!c){return this}if(d.addlabel===true){c.appendChild(this.utils.DOMcreatelabel({labelfor:this.transposerangeid,labeltext:(d.labeltext!==undefined)?d.labeltext:"Transpose Amount"}))}var b=this.utils.DOMaddrange({id:this.transposerangeid,min:-12,max:12,step:1,value:this.scalesettings.scaletranspose});c.appendChild(b);var a=this;b.addEventListener("change",function(){a.settranspose(parseInt(this.value))});return this};TBWMNotequantiser.prototype.applyscale=function(c){var a=Math.floor(c/12);var b=(c+this.scalesettings.scaleshift)%12;if((this.scalesettings.scalerandomise>0)&&(Math.random()<=this.scalesettings.scalerandomise)){b=Math.round(Math.random()*11)}if((this.scalesettings.scaleflatten>0)&&(Math.random()<=this.scalesettings.scaleflatten)){b=0}return Math.max(Math.min(12*a+this.scale[b]+this.scalesettings.scaletranspose,127),0)};TBWMNotequantiser.prototype.getscales=function(){return this.mpscales};TBWMNotequantiser.prototype.logscales=function(){for(var a=0;a<this.mpscales.length;a++){console.log(a+": "+this.mpscales[a]["name"])}};TBWMNotequantiser.prototype.getscaleinfo=function(){return{index:this.scaleindex,name:this.scalesettings.mpscales[this.scaleindex]["name"],scale:this.scale}};TBWMNotequantiser.prototype.logscaleinfo=function(){console.log({index:this.scaleindex,name:this.scalesettings.mpscales[this.scaleindex]["name"],scale:this.scale})};