function TBWMClock(a){this.workerurl=null;if(a.workerurl){this.workerurl=a.workerurl}else{console.log("Error: Webworker URL must be set relative to HTML page by passing object {workerurl : '<url>'} when instantiating this object");return this}this.tempo=120;if(a.bpm){this.tempo=a.bpm}this.audioContext=null;this.isplaying=false;this.startTime;this.lookahead=10;this.scheduleAheadTime=0.1;this.nexttickTime=0;this.timerWorker=null;this.secondsPerTick=2.5/this.tempo;this.newTempo=this.tempo;this.playbuttonid="tbwm-clock-playbutton";this.temporangeid="tbwm-clock-temporange";this.utils=null;try{if(typeof TBWMSharedfunctions()===undefined){throw"TBWMSharedfunctions() Object not available"}else{this.utils=new TBWMSharedfunctions()}}catch(b){this.errornoutils(b)}this.init();return this}MicroEvent.mixin(TBWMClock);TBWMClock.prototype.nexttick=function(){var a=this;this.nexttickTime+=this.secondsPerTick;if(this.tempo!=this.newTempo){this.tempo=this.newTempo;this.secondsPerTick=2.5/this.tempo}};TBWMClock.prototype.scheduletick=function(b){var a=this;a.trigger("tick","tick")};TBWMClock.prototype.scheduler=function(){while(this.nexttickTime<this.audioContext.currentTime+this.scheduleAheadTime){this.scheduletick(this.nexttickTime);this.nexttick()}};TBWMClock.prototype.settempo=function(a){this.newTempo=a;return this};TBWMClock.prototype.start=function(){this.nexttickTime=this.audioContext.currentTime;this.timerWorker.postMessage("start");console.log("TBWMClock: Starting 24PPQN Clock");this.isplaying=true;return this};TBWMClock.prototype.stop=function(){this.timerWorker.postMessage("stop");console.log("TBWMClock: Stopping 24PPQN Clock");this.isplaying=false;return this};TBWMClock.prototype.addplaybutton=function(c){if(this.utils&&c&&c.domcontainer){var b=this.utils.DOMcheckelement(c.domcontainer);if(!b){return this}var f="Start Clock";if(c.starttext){f=c.starttext}var e="Stop Clock";if(c.starttext){e=c.stoptext}var d=this.utils.DOMaddbutton({id:this.playbuttonid,text:(c.buttontext!==undefined)?c.buttontext:f});b.appendChild(d);var a=this;d.addEventListener("mouseup",function(){if(!a.isplaying){a.utils.DOMchangebuttontext({button:this,text:e});a.start()}else{a.utils.DOMchangebuttontext({button:this,text:f});a.stop();a.trigger("reset","reset")}},false)}else{return this}return this};TBWMClock.prototype.addtemporange=function(d){if(!this.utils){return this}var c=this.utils.DOMcheckelement(d.domcontainer);if(!c){return this}if(d.addlabel===true){c.appendChild(this.utils.DOMcreatelabel({labelfor:this.temporangeid,labeltext:(d.labeltext!==undefined)?d.labeltext:"Tempo"}))}var b=this.utils.DOMaddrange({id:this.temporangeid,min:50,max:200,step:1,value:this.tempo});c.appendChild(b);var a=this;b.addEventListener("change",function(){a.settempo(parseInt(this.value))});return this};TBWMClock.prototype.init=function(){var a=this;this.audioContext=new AudioContext();var b=this.audioContext.createOscillator();this.timerWorker=new Worker(this.workerurl);this.timerWorker.addEventListener("message",function(c){if(c.data=="tick"){a.scheduler()}else{console.log("TNWMClock: message: "+c.data)}},false);this.timerWorker.postMessage({interval:this.lookahead});return this};