function TBMWMIDIio(){this.uicontainer=null;this.containerclass="midiui";this.idprefix="tbwm-io";this.outputselectid=this.idprefix+"-outputdevice";this.channelselectid=this.idprefix+"-channel";this.testoutputbutton=this.idprefix+"-testoutput";this.havemidi=false;this.havemidiin=false;this.havemidiout=false;this.havecontainer=false;this.midiaccess={};this.outputs={};this.inputs={};this.midiout={};this.midiin={};this.midichannel=1;return this}MicroEvent.mixin(TBMWMIDIio);TBMWMIDIio.prototype.setcookie=function(b,f,c){var e=new Date();e.setTime(e.getTime()+(c*24*60*60*1000));var a="expires="+e.toUTCString();document.cookie=b+"="+f+"; "+a};TBMWMIDIio.prototype.getcookie=function(d){var b=d+"=";var a=document.cookie.split(";");for(var e=0;e<a.length;e++){var f=a[e];while(f.charAt(0)==" "){f=f.substring(1)}if(f.indexOf(b)==0){return f.substring(b.length,f.length)}}return""};TBMWMIDIio.prototype.errordomelement=function(){var a="Error: Container element not found. You need to specify ID of an existing element (with or without leading '#') when initialising this instance or calling this method";console.log(a);return a};TBMWMIDIio.prototype.createlabel=function(c,b){var a=document.createElement("label");a.setAttribute("for",c);a.innerHTML=b;return a};TBMWMIDIio.prototype.errornomidi=function(b){this.havemidi=false;var a=b;console.log(a)};TBMWMIDIio.prototype.errornooutputdevice=function(){this.havemidiout=false;var a="Error: No MIDI output device is accessible.";console.log(a)};TBMWMIDIio.prototype.errornoinputdevice=function(){this.havemidi=false;var a="Error: No MIDI input device is accessible.";console.log(a)};TBMWMIDIio.prototype.channelmessage=function(c,a){var b={noteoff:8,noteon:9,controlchange:11,channelmode:11,programchange:12,channelaftertouch:13,pitchbend:14,allnotesoff:123};if(!b[c]){console.log("Error: MIDI Channel message not found")}else{return(b[c]<<4)+(a-1)}};TBMWMIDIio.prototype.systemmessage=function(b){var a={sysex:240,timecode:241,songposition:242,songselect:243,tuningrequest:246,sysexend:247,clock:248,start:250,"continue":251,stop:252,activesensing:254,reset:255,};if(!a[b]){console.log("Error: MIDI System message not found")}else{return(a[b]<<4)+(ch-1)}};TBMWMIDIio.prototype.time=function(b){var a=window.performance.now();if(b){return a+b}else{return a}};TBMWMIDIio.prototype.init=function(c){if(c){this.uicontainer=document.getElementById(c.replace("#",""));if(!this.uicontainer){return this.errordomelement()}}else{return this.errordomelement()}this.havecontainer=true;this.uicontainer.classList.add(this.containerclass);var b=this;navigator.requestMIDIAccess().then(d,a);function d(e){b.havemidi=true;b.midiaccess=e;b.outputs=b.midiaccess.outputs;if(b.outputs.size>0){b.midiout=b.outputs.values().next().value;b.midiout.open();b.havemidiout=true}else{b.errornooutputdevice();b.havemidiout=false}console.log("MIDI system success!");b.trigger("midistatus","success")}function a(e){b.havemidi=false;b.havemidiin=false;b.havemidiout=false;console.log("Uh-oh! Something went wrong! Error code: "+e.code);b.trigger("midistatus","fail")}return this};TBMWMIDIio.prototype.setoutputdevice=function(a){if(this.havemidiout){var b=null;this.outputs.forEach(function(c){if(c.id===a||c.name===a){if(!b){b=c}}});if(b){this.midiout.close();this.midiout=b;this.midiout.open()}else{console.log("Error: MIDI output port "+a+" not available")}}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.addoutputselect=function(d){if(this.havemidi&&this.havemidiout){var c=null;if(d.savetocookie&&d.savetocookie===true){c=this.getcookie("midioutportname");if(c){this.setoutputdevice(c)}}var b=this.createlabel(this.outputselectid,"Select MIDI Output Device");var e=document.createElement("select");e.setAttribute("id",this.outputselectid);this.outputs.forEach(function(f){var g=document.createElement("option");g.text=f.name;if(c&&c===f.name){g.setAttribute("selected","selected")}g.value=f.id;e.add(g)});this.uicontainer.appendChild(b);this.uicontainer.appendChild(e);var a=this;e.addEventListener("change",function(){a.setoutputdevice(this.value);if(savetocookie===true){a.setcookie("midioutportname",e.options[e.selectedIndex].text,365)}})}else{this.errornooutputdevice()}return this};TBMWMIDIio.prototype.setoutmidichannel=function(a){this.midichannel=parseInt(a)};TBMWMIDIio.prototype.addoutchannelselect=function(f){if(this.havemidi&&this.havemidiout){var a=null;var h=false;if(f.savetocookie&&f.savetocookie===true){h=true;a=this.getcookie("midioutchannel");if(a){this.setoutmidichannel(a)}}var c=this.createlabel(this.channelselectid,"Select MIDI Channel");var g=document.createElement("select");g.setAttribute("id",this.channelselectid);for(var e=1;e<17;e++){var d=document.createElement("option");d.text=e;d.value=e;if(a&&parseInt(a)===e){d.setAttribute("selected","selected")}g.add(d)}this.uicontainer.appendChild(c);this.uicontainer.appendChild(g);var b=this;g.addEventListener("change",function(){b.setoutmidichannel(parseInt(this.value));if(h){b.setcookie("midioutchannel",g.options[g.selectedIndex].text,365)}})}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.addtestbutton=function(){if(this.havemidi&&this.havemidiout){var b=document.createElement("button");b.setAttribute("id",this.testoutputbutton);b.innerHTML="Test MIDI Out";this.uicontainer.appendChild(b);var a=this;b.addEventListener("mousedown",function(){a.send_noteon(null,64,127,null)},false);b.addEventListener("mouseup",function(){a.send_noteoff(null,64,127,null)},false)}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_noteon=function(e,c,d,a){if(this.havemidi&&this.havemidiout){var b=(e)?e:this.midichannel;var f=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("noteon",b),c,d],f);console.log("NoteOn Note: "+c+" Time: "+f+" MIDI message: "+[this.channelmessage("noteon",b),c,d])}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_noteoff=function(e,c,d,a){if(this.havemidi&&this.havemidiout){var b=(e)?e:this.midichannel;var f=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("noteoff",b),c,0],f);console.log("NoteOff Note: "+c+" Time: "+f+" MIDI message: "+[this.channelmessage("noteoff",b),c,0])}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_allnotesoff=function(c,a){if(this.havemidi&&this.havemidiout){var b=(c)?c:this.midichannel;var d=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("allnotesoff",b),0,0],this.time())}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_controller=function(c,f,d,a){if(this.havemidi&&this.havemidiout){var b=(c)?c:this.midichannel;var e=(a)?this.time(a):this.time();this.midiout.send([this.channelmessage("controller",b),f,d],e)}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_clocktick=function(){if(this.havemidi&&this.havemidiout){this.midiout.send([this.systemmessage("clock")],this.time())}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_clockstop=function(){if(this.havemidi&&this.havemidiout){this.midiout.send([this.systemmessage("stop")],this.time())}else{this.errornooutputdevice();return}return this};TBMWMIDIio.prototype.send_clockcontinue=function(){if(this.havemidi&&this.havemidiout){this.midiout.send([this.systemmessage("continue")],this.time())}else{this.errornooutputdevice();return}return this};