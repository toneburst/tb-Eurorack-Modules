function Clock(a,b){this.tempo=a;this.audioContext=null;this.isPlaying=false;this.startTime;this.lookahead=10;this.scheduleAheadTime=0.1;this.nextNoteTime=0;this.notesCounter=0;this.timerWorker=null;this.noteOn=1;this.secondsPerNote=15/this.tempo;this.gateLength=b*this.secondsPerNote;this.newGateLength=this.gateLength;this.newTempo=this.tempo;this.resetPeriod=15;this.autoReset=false}MicroEvent.mixin(Clock);Clock.prototype.log=function(a){console.log(a)};Clock.prototype.setTempo=function(a){this.newTempo=a};Clock.prototype.setGateLength=function(a){this.newGateLength=Math.min(a,0.9)};Clock.prototype.setResetPeriod=function(a){if(a!=="0"){this.resetPeriod=Math.round(a);this.autoReset=true}else{autoReset=false}};Clock.prototype.isRunning=function(){return this.isPlaying};Clock.prototype.nextNote=function(){var a=this;if(this.noteOn===1){this.nextNoteTime+=this.gateLength;this.notesCounter++;if(this.autoReset&&(this.notesCounter%this.resetPeriod)===0){this.notesCounter=0;a.trigger("reset")}}else{this.nextNoteTime+=this.secondsPerNote-this.gateLength;if(this.tempo!=this.newTempo){this.tempo=this.newTempo;this.secondsPerNote=15/this.tempo}if(this.gateLength!=this.newGateLength){this.gateLength=this.newGateLength*this.secondsPerNote}}this.noteOn=1-this.noteOn};Clock.prototype.scheduleNote=function(b){var a=this;if(this.noteOn===1){if(a.notesCounter%16===0){a.trigger("bar")}a.trigger("tick",this.notesCounter)}else{a.trigger("note-off","Note Off")}};Clock.prototype.scheduler=function(){while(this.nextNoteTime<this.audioContext.currentTime+this.scheduleAheadTime){this.scheduleNote(this.nextNoteTime);this.nextNote()}};Clock.prototype.play=function(){this.nextNoteTime=this.audioContext.currentTime;this.notesCounter=0;this.timerWorker.postMessage("start");console.log("Starting clock");this.isPlaying=true};Clock.prototype.stop=function(){this.timerWorker.postMessage("stop");console.log("Stopping clock");this.isPlaying=false};Clock.prototype.init=function(){var a=this;this.audioContext=new AudioContext();var b=this.audioContext.createOscillator();this.timerWorker=new Worker("js/lib/clock/clockworker.min.js");this.timerWorker.addEventListener("message",function(c){if(c.data=="tick"){a.scheduler()}else{console.log("message: "+c.data)}},false);this.timerWorker.postMessage({interval:this.lookahead})};