function getrandom(e,n){return Math.round(Math.random()*e)+n}function U8Mix(e,n,t){return 255==t?n:t*n+(255-t)*e>>8}function U8Switch(e,n,t){return t>>7==0?e:n}function getcorners(e,n,t,o,a){var r=[coordtable[n][0],coordtable[t][0]],i=e[r[1]][r[0]][o][a],l=e[r[1]][r[0]+1][o][a],s=e[r[1]+1][r[0]][o][a],c=e[r[1]+1][r[0]+1][o][a];return[i,l,s,c]}function bilinear(e,n,t,o,a){var r=getcorners(e,t,o,n,a),i=[coordtable[t][1],coordtable[o][1]];return U8Mix(U8Mix(r[0],r[1],i[0]),U8Mix(r[2],r[3],i[0]),i[1])}function cornerswitch(e,n,t,o,a){var r=(channelstepcount[n][1],getcorners(e,t,o,n,a)),i=[coordtable[t][1],coordtable[o][1]];return U8Switch(U8Switch(r[0],r[1],i[0]),U8Switch(r[2],r[3],i[0]),i[1])}function calculatetrigger(e,n,t,o){var a=t>n?1:0;if(t>191&&t-192>n>>2){var r=channelstepcount[e][3]%(randomtable[e].length-1);channelstepcount[e][3]+=t>238?o:1,a=randomtable[e][r]}return a}function calculatenoteoct(e,n,t,o,a,r,i){var l;if(127>t)n>t&&(l=o);else if(t>=127&&t-127>n){var s=channelstepcount[e][2]+randomtablecounter;250>t&&(s+=r),s%=randomtable[a].length-1,l=(l+randomtable[0][s])%i}return l}function playStep(){var e=stepvals[0],n=stepvals[1],t=thresholds[0],o=stepvals[2],a=stepvals[3],r=thresholds[1],l=stepvals[4],s=thresholds[2];if(127>t)n>t&&(e=0);else if(t>=127&&t-127>n){var c=channelstepcount[0][2]+randomtablecounter;250>t&&(c+=randomtablerandomincrement),c%=randomtable[0].length-1,e=(e+randomtable[0][c])%11}if(127>r)a>r&&(o=1);else if(r>=127&&r-127>a){var c=channelstepcount[1][2]+randomtablecounter;250>r&&(c+=randomtablerandomincrement),c%=randomtable[1].length-1,o=(o+randomtable[1][c])%2}var u=scale[e]+12*o+transpose,d=0===calculatetrigger(2,l,s,randomtablerandomincrement)?midi_lowvelocity:midi_highvelocity,m=slide&&u==midi_previousnotes[midi_previousnotes.length-1]?!0:!1;if(!m){var h=quantiser.applyscale(u);midiout.send_noteon(null,h,d,null),midi_previousnotes.push(h)}for(i=0;i<channelstepcount.length;i++){var p=channelstepcount[i][0],v=channelstepcount[i][1];channelstepcount[i][2]=(masterstepcounter+v)%p}masterstepcounter%channelstepcount[0][0]==0&&(randomtablecounter=randomtablecounter<channelstepcount[0][0]-1?randomtablecounter+1:0,randomtablerandomincrement=getrandom(7,0))}function getStepVals(){if(slide=!1,slide)midi_previousnotes.length>1&&midiout.send_noteoff(null,midi_previousnotes.shift(),0,null);else{for(i=0;i<midi_previousnotes.length-1;i++)midiout.send_noteoff(null,midi_previousnotes.shift(),0,null);midi_previousnotes=[]}var e=[0,0,1,1,2,3];for(i=0;i<stepvals.length;i++){var n=e[i];2==i?stepvals[i]=cornerswitch(patterns,i,valx,valy,channelstepcount[n][2]):stepvals[i]=bilinear(patterns,i,valx,valy,channelstepcount[n][2])}}