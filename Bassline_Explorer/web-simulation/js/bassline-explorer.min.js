function getrandom(e,n){return Math.round(Math.random()*e)+n}function U8Mix(e,n,t){return 255==t?n:t*n+(255-t)*e>>8}function U8Switch(e,n,t){return t>>7==0?e:n}function getcorners(e,n,t,r,o){var i=[coordtable[n][0],coordtable[t][0]],a=e[i[1]][i[0]][r][o],s=e[i[1]][i[0]+1][r][o],l=e[i[1]+1][i[0]][r][o],c=e[i[1]+1][i[0]+1][r][o];return[a,s,l,c]}function bilinear(e,n,t,r,o){var i=getcorners(e,t,r,n,o),a=[coordtable[t][1],coordtable[r][1]];return U8Mix(U8Mix(i[0],i[1],a[0]),U8Mix(i[2],i[3],a[0]),a[1])}function cornerswitch(e,n,t,r,o){var i=(channelstepcount[n][1],getcorners(e,t,r,n,o)),a=[coordtable[t][1],coordtable[r][1]];return U8Switch(U8Switch(i[0],i[1],a[0]),U8Switch(i[2],i[3],a[0]),a[1])}function randomisetrigger(e,n,t,r){var o=t>n?1:0;if(t>191&&t-192>n>>2){var i=channelstepcount[e][3]%(randomtable[e].length-1);channelstepcount[e][3]+=t>238?r:1,o=randomtable[e][i]}return o}function playStep(){var e=stepvals[0],n=stepvals[1],t=thresholds[0],r=stepvals[2],o=stepvals[3],a=thresholds[1],s=stepvals[4],l=thresholds[2];if(127>t)n>t&&(e=0);else if(t>=127&&t-127>n){var c=channelstepcount[0][2]+randomtablecounter;250>t&&(c+=randomtablerandomincrement),c%=randomtable[0].length-1,e=(e+randomtable[0][c])%11}if(127>a)o>a&&(r=1);else if(a>=127&&a-127>o){var c=channelstepcount[1][2]+randomtablecounter;250>a&&(c+=randomtablerandomincrement),c%=randomtable[1].length-1,r=(r+randomtable[1][c])%2}var d=scale[e]+12*r+transpose,m=0===randomisetrigger(2,s,l,randomtablerandomincrement)?midi_lowvelocity:midi_highvelocity,u=slide&&d==midi_previousnotes[midi_previousnotes.length-1]?!0:!1;for(u||midi_noteon(midi_channel,d,m),midi_previousnotes.push(d),i=0;i<channelstepcount.length;i++){var h=channelstepcount[i][0],p=channelstepcount[i][1];channelstepcount[i][2]=(masterstepcounter+p)%h}masterstepcounter%channelstepcount[0][0]==0&&(randomtablecounter=randomtablecounter<channelstepcount[0][0]-1?randomtablecounter+1:0,randomtablerandomincrement=getrandom(7,0))}function getStepVals(){if(slide=0===randomisetrigger(3,stepvals[5],thresholds[3],randomtablerandomincrement)?!1:!0,slide)midi_previousnotes.length>1&&midi_noteoff(midi_channel,midi_previousnotes.shift(),0);else{for(i=0;i<midi_previousnotes.length;i++)midi_noteoff(midi_channel,midi_previousnotes[i],0);midi_previousnotes=[]}var e=[0,0,1,1,2,3];for(i=0;i<stepvals.length;i++){var n=e[i];2==i?stepvals[i]=cornerswitch(patterns,i,valx,valy,channelstepcount[n][2]):stepvals[i]=bilinear(patterns,i,valx,valy,channelstepcount[n][2])}}