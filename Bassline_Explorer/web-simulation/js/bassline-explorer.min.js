function getrandom(a,b){return Math.round(Math.random()*a)+b}function U8Mix(e,d,c){return(c==255)?d:c*d+(255-c)*e>>8}function U8Switch(e,d,c){return(c>>7==0)?e:d}function getcorners(g,n,k,e,o){var f=[coordtable[n][0],coordtable[k][0]];var m=g[f[1]][f[0]][e][o];var l=g[f[1]][f[0]+1][e][o];var j=g[f[1]+1][f[0]][e][o];var h=g[f[1]+1][f[0]+1][e][o];return[m,l,j,h]}function bilinear(d,e,b,g,a){var c=getcorners(d,b,g,e,a);var f=[coordtable[b][1],coordtable[g][1]];return U8Mix(U8Mix(c[0],c[1],f[0]),U8Mix(c[2],c[3],f[0]),f[1])}function cornerswitch(d,e,b,h,a){var f=channelstepcount[e][1];var c=getcorners(d,b,h,e,a);var g=[coordtable[b][1],coordtable[h][1]];return U8Switch(U8Switch(c[0],c[1],g[0]),U8Switch(c[2],c[3],g[0]),g[1])}function randomisetrigger(e,b,f,d){var a=(b<f)?1:0;if(f>191){if((b>>2)<(f-192)){var c=(channelstepcount[e][3])%(randomtable[e].length-1);channelstepcount[e][3]+=(f>238)?d:1;a=randomtable[e][c]}}return a}function playStep(){var j=stepvals[0];var o=stepvals[1];var f=thresholds[0];var n=stepvals[2];var h=stepvals[3];var l=thresholds[1];var b=stepvals[4];var k=thresholds[2];if(f<127){if(o>f){j=0}}else{if(f>=127){if(o<(f-127)){var d=(channelstepcount[0][2]+randomtablecounter);if(f<250){d+=randomtablerandomincrement}d=d%(randomtable[0].length-1);j=(j+randomtable[0][d])%11}}}if(l<127){if(h>l){n=1}}else{if(l>=127){if(h<(l-127)){var d=(channelstepcount[1][2]+randomtablecounter);if(l<250){d+=randomtablerandomincrement}d=d%(randomtable[1].length-1);n=(n+randomtable[1][d])%2}}}var e=scale[j]+(12*n)+transpose;var m=(randomisetrigger(2,b,k,randomtablerandomincrement)===0)?midi_lowvelocity:midi_highvelocity;var a=(slide&&e==midi_previousnotes[midi_previousnotes.length-1])?true:false;if(!a){midi_noteon(midi_channel,e,m)}midi_previousnotes.push(e);for(i=0;i<channelstepcount.length;i++){var c=channelstepcount[i][0];var g=channelstepcount[i][1];channelstepcount[i][2]=(masterstepcounter+g)%c}if(masterstepcounter%channelstepcount[0][0]==0){randomtablecounter=(randomtablecounter<(channelstepcount[0][0]-1))?randomtablecounter+1:0;randomtablerandomincrement=getrandom(7,0)}}function getStepVals(){slide=(randomisetrigger(3,stepvals[5],thresholds[3],randomtablerandomincrement)===0)?false:true;if(slide){if(midi_previousnotes.length>2){midi_noteoff(midi_channel,midi_previousnotes.shift(),0)}}else{for(i=0;i<midi_previousnotes.length;i++){midi_noteoff(midi_channel,midi_previousnotes[i],0)}midi_previousnotes=[]}var b=[0,0,1,1,2,3];for(i=0;i<stepvals.length;i++){var a=b[i];if(i==2){stepvals[i]=cornerswitch(patterns,i,valx,valy,channelstepcount[a][2])}else{stepvals[i]=bilinear(patterns,i,valx,valy,channelstepcount[a][2])}}};