function getrandom(e,t){return Math.round(Math.random()*e)+t}function U8Mix(e,t,n){return 255==n?t:n*t+(255-n)*e>>8}function U8Switch(e,t,n){return n>>7==0?e:t}function getcorners(e,t,n,r,o){var a=[coordtable[t][0],coordtable[n][0]],i=e[a[1]][a[0]][r][o],l=e[a[1]][a[0]+1][r][o],s=e[a[1]+1][a[0]][r][o],c=e[a[1]+1][a[0]+1][r][o];return[i,l,s,c]}function bilinear(e,t,n,r,o){var a=getcorners(e,n,r,t,o),i=[coordtable[n][1],coordtable[r][1]];return U8Mix(U8Mix(a[0],a[1],i[0]),U8Mix(a[2],a[3],i[0]),i[1])}function cornerswitch(e,t,n,r,o){var a=(channelstepcount[t][1],getcorners(e,n,r,t,o)),i=[coordtable[n][1],coordtable[r][1]];return U8Switch(U8Switch(a[0],a[1],i[0]),U8Switch(a[2],a[3],i[0]),i[1])}function calculatetrigger(e,t,n,r){var o=n>t?1:0;if(n>191&&n-192>t>>2){var a=channelstepcount[e][3]%(randomtable[e].length-1);channelstepcount[e][3]+=n>238?r:1,o=randomtable[e][a]}return o}function playStep(){var e=stepvals[0],t=stepvals[1],n=thresholds[0],r=stepvals[2],o=stepvals[3],a=thresholds[1],l=stepvals[4],s=thresholds[2];if(127>n)t>n&&(e=0);else if(n>=127&&n-127>t){var c=channelstepcount[0][2]+randomtablecounter;250>n&&(c+=randomtablerandomincrement),c%=randomtable[0].length-1,e=(e+randomtable[0][c])%11}if(127>a)o>a&&(r=1);else if(a>=127&&a-127>o){var c=channelstepcount[1][2]+randomtablecounter;250>a&&(c+=randomtablerandomincrement),c%=randomtable[1].length-1,r=(r+randomtable[1][c])%2}var u=scale[e]+12*r+transpose,d=0===calculatetrigger(2,l,s,randomtablerandomincrement)?midi_lowvelocity:midi_highvelocity,m=slide&&u==midi_previousnotes[midi_previousnotes.length-1]?!0:!1;if(!m){var h=quantiser.applyscale(u);midiout.send_noteon(null,h,d),midi_previousnotes.push(h)}for(i=0;i<channelstepcount.length;i++){var p=channelstepcount[i][0],v=channelstepcount[i][1];channelstepcount[i][2]=(masterstepcounter+v)%p}masterstepcounter%channelstepcount[0][0]==0&&(randomtablecounter=randomtablecounter<channelstepcount[0][0]-1?randomtablecounter+1:0,randomtablerandomincrement=getrandom(7,0))}function getStepVals(){if(slide=0===calculatetrigger(3,stepvals[5],thresholds[3],randomtablerandomincrement)?!1:!0,slide)midi_previousnotes.length>1&&midiout.send_noteoff(null,midi_previousnotes.shift(),0);else{for(i=0;i<midi_previousnotes.length;i++)midiout.send_noteoff(null,midi_previousnotes.shift(),0);midi_previousnotes=[]}var e=[0,0,1,1,2,3];for(i=0;i<stepvals.length;i++){var t=e[i];2==i?stepvals[i]=cornerswitch(patterns,i,valx,valy,channelstepcount[t][2]):stepvals[i]=bilinear(patterns,i,valx,valy,channelstepcount[t][2])}}